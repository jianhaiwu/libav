From: Peter Fritzsche <peter.fritzsche@gmx.de>
Date: Sat, 23 May 2009 05:55:29 +0000
Subject: [PATCH] fix qtrle encoding when previous frame linesize differs

Applied upstream as revision 18908:

------------------------------------------------------------------------
r18908 | bcoudurier | 2009-05-23 07:55:29 +0200 (Sa, 23. Mai 2009) | 1 line

fix qtrle encoding when previous frame linesize differs, fix #998


Index: ffmpeg-debian/libavcodec/qtrleenc.c
===================================================================
--- ffmpeg-debian.orig/libavcodec/qtrleenc.c	2009-07-06 13:12:54.000000000 -0400
+++ ffmpeg-debian/libavcodec/qtrleenc.c	2009-07-06 13:13:51.000000000 -0400
@@ -126,8 +126,10 @@
     int temp_cost;
     int j;
 
-    uint8_t *this_line = p->               data[0] + line*p->linesize[0] + (width - 1)*s->pixel_size;
-    uint8_t *prev_line = s->previous_frame.data[0] + line*p->linesize[0] + (width - 1)*s->pixel_size;
+    uint8_t *this_line = p->               data[0] + line*p->               linesize[0] +
+        (width - 1)*s->pixel_size;
+    uint8_t *prev_line = s->previous_frame.data[0] + line*s->previous_frame.linesize[0] +
+        (width - 1)*s->pixel_size;
 
     s->length_table[width] = 0;
     skipcount = 0;
@@ -240,16 +242,17 @@
     uint8_t *orig_buf = buf;
 
     if (!s->frame.key_frame) {
+        unsigned line_size = s->avctx->width * s->pixel_size;
         for (start_line = 0; start_line < s->avctx->height; start_line++)
             if (memcmp(p->data[0] + start_line*p->linesize[0],
-                       s->previous_frame.data[0] + start_line*p->linesize[0],
-                       p->linesize[0]))
+                       s->previous_frame.data[0] + start_line*s->previous_frame.linesize[0],
+                       line_size))
                 break;
 
         for (end_line=s->avctx->height; end_line > start_line; end_line--)
             if (memcmp(p->data[0] + (end_line - 1)*p->linesize[0],
-                       s->previous_frame.data[0] + (end_line - 1)*p->linesize[0],
-                       p->linesize[0]))
+                       s->previous_frame.data[0] + (end_line - 1)*s->previous_frame.linesize[0],
+                       line_size))
                 break;
     }
 
