From 5f0e161dd61552ad70760bad35b869eaec7368ff Mon Sep 17 00:00:00 2001
From: Luca Barbato <lu_zero@gentoo.org>
Date: Wed, 24 Oct 2012 18:18:18 +0200
Subject: [PATCH 022/278] g722: refactor out of rawdec.c

---
 libavformat/Makefile |    2 +-
 libavformat/g722.c   |   56 ++++++++++++++++++++++++++++++++++++++++++++++++++
 libavformat/rawdec.c |   12 -----------
 3 files changed, 57 insertions(+), 13 deletions(-)
 create mode 100644 libavformat/g722.c

diff --git a/libavformat/Makefile b/libavformat/Makefile
index a285af1..832ea41 100644
--- a/libavformat/Makefile
+++ b/libavformat/Makefile
@@ -101,7 +101,7 @@ OBJS-$(CONFIG_GIF_MUXER)                 += gif.o
 OBJS-$(CONFIG_GSM_DEMUXER)               += gsmdec.o
 OBJS-$(CONFIG_GXF_DEMUXER)               += gxf.o
 OBJS-$(CONFIG_GXF_MUXER)                 += gxfenc.o audiointerleave.o
-OBJS-$(CONFIG_G722_DEMUXER)              += rawdec.o
+OBJS-$(CONFIG_G722_DEMUXER)              += g722.o rawdec.o
 OBJS-$(CONFIG_G722_MUXER)                += rawenc.o
 OBJS-$(CONFIG_G723_1_DEMUXER)            += g723_1.o
 OBJS-$(CONFIG_H261_DEMUXER)              += h261dec.o rawdec.o
diff --git a/libavformat/g722.c b/libavformat/g722.c
new file mode 100644
index 0000000..8052939
--- /dev/null
+++ b/libavformat/g722.c
@@ -0,0 +1,56 @@
+/*
+ * g722 raw demuxer
+ * Copyright (c) 2010 Martin Storsjo
+ *
+ * This file is part of Libav.
+ *
+ * Libav is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * Libav is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with Libav; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ */
+
+#include "avformat.h"
+#include "internal.h"
+#include "rawdec.h"
+
+static int g722_read_header(AVFormatContext *s)
+{
+    AVStream *st;
+
+    st = avformat_new_stream(s, NULL);
+    if (!st)
+        return AVERROR(ENOMEM);
+
+    st->codec->codec_type  = AVMEDIA_TYPE_AUDIO;
+    st->codec->codec_id    = AV_CODEC_ID_ADPCM_G722;
+    st->codec->sample_rate = 16000;
+    st->codec->channels    = 1;
+
+    st->codec->bits_per_coded_sample =
+        av_get_bits_per_sample(st->codec->codec_id);
+
+    assert(st->codec->bits_per_coded_sample > 0);
+
+    avpriv_set_pts_info(st, 64, 1, st->codec->sample_rate);
+    return 0;
+}
+
+AVInputFormat ff_g722_demuxer = {
+    .name           = "g722",
+    .long_name      = NULL_IF_CONFIG_SMALL("raw G.722"),
+    .read_header    = g722_read_header,
+    .read_packet    = ff_raw_read_partial_packet,
+    .flags          = AVFMT_GENERIC_INDEX,
+    .extensions     = "g722,722",
+    .raw_codec_id   = AV_CODEC_ID_ADPCM_G722,
+};
diff --git a/libavformat/rawdec.c b/libavformat/rawdec.c
index 7ea3d2b..fd1e9b9 100644
--- a/libavformat/rawdec.c
+++ b/libavformat/rawdec.c
@@ -177,18 +177,6 @@ const AVOption ff_rawvideo_options[] = {
     { NULL },
 };
 
-#if CONFIG_G722_DEMUXER
-AVInputFormat ff_g722_demuxer = {
-    .name           = "g722",
-    .long_name      = NULL_IF_CONFIG_SMALL("raw G.722"),
-    .read_header    = ff_raw_read_header,
-    .read_packet    = ff_raw_read_partial_packet,
-    .flags          = AVFMT_GENERIC_INDEX,
-    .extensions     = "g722,722",
-    .raw_codec_id   = AV_CODEC_ID_ADPCM_G722,
-};
-#endif
-
 #if CONFIG_LATM_DEMUXER
 AVInputFormat ff_latm_demuxer = {
     .name           = "latm",
-- 
1.7.9.5

