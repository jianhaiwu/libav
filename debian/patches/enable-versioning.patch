Author: Reinhard Tartler <siretart@tauware.de>

backport symbol versioning patch

Index: ffmpeg/common.mak
===================================================================
--- ffmpeg.orig/common.mak	2010-01-01 18:57:45.000000000 +0000
+++ ffmpeg/common.mak	2010-01-01 18:57:51.000000000 +0000
@@ -77,7 +77,7 @@
 DEPS := $(OBJS:.o=.d)
 depend dep: $(DEPS)
 
-CLEANSUFFIXES = *.o *~ *.ho
+CLEANSUFFIXES = *.o *~ *.ho *.ver
 LIBSUFFIXES   = *.a *.lib *.so *.so.* *.dylib *.dll *.def *.dll.a *.exp *.map
 DISTCLEANSUFFIXES = *.d *.pc
 
Index: ffmpeg/libavcodec/libavcodec.v
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ ffmpeg/libavcodec/libavcodec.v	2010-01-01 18:57:51.000000000 +0000
@@ -0,0 +1,3 @@
+LIBAVCODEC_%MAJOR% {
+	global: *;
+};
Index: ffmpeg/libavdevice/libavdevice.v
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ ffmpeg/libavdevice/libavdevice.v	2010-01-01 18:57:51.000000000 +0000
@@ -0,0 +1,4 @@
+LIBAVDEVICE_%MAJOR% {
+	global: avdevice_*;
+	local: *;
+};
Index: ffmpeg/libavfilter/libavfilter.v
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ ffmpeg/libavfilter/libavfilter.v	2010-01-01 18:57:51.000000000 +0000
@@ -0,0 +1,4 @@
+LIBAVFILTER_%MAJOR% {
+	global: avfilter_*; av_*;
+	local: *;
+};
Index: ffmpeg/libavformat/libavformat.v
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ ffmpeg/libavformat/libavformat.v	2010-01-01 18:57:51.000000000 +0000
@@ -0,0 +1,3 @@
+LIBAVFORMAT_%MAJOR% {
+	global: *;
+};
Index: ffmpeg/libavutil/libavutil.v
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ ffmpeg/libavutil/libavutil.v	2010-01-01 18:57:51.000000000 +0000
@@ -0,0 +1,4 @@
+LIBAVUTIL_%MAJOR% {
+	global: av_*; ff_*; avutil_*;
+	local: *;
+};
Index: ffmpeg/libpostproc/libpostproc.v
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ ffmpeg/libpostproc/libpostproc.v	2010-01-01 18:57:51.000000000 +0000
@@ -0,0 +1,4 @@
+LIBPOSTPROC_%MAJOR% {
+	global: postproc_*; pp_*;
+	local: *;
+};
Index: ffmpeg/libswscale/libswscale.v
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ ffmpeg/libswscale/libswscale.v	2010-01-01 18:57:51.000000000 +0000
@@ -0,0 +1,3 @@
+LIBSWSCALE_%MAJOR% {
+	global: *;
+};
Index: ffmpeg/subdir.mak
===================================================================
--- ffmpeg.orig/subdir.mak	2010-01-01 18:57:45.000000000 +0000
+++ ffmpeg/subdir.mak	2010-01-01 19:00:26.000000000 +0000
@@ -27,9 +27,14 @@
 $(SUBDIR)$(SLIBNAME): $(SUBDIR)$(SLIBNAME_WITH_MAJOR)
 	cd ./$(SUBDIR) && $(LN_S) $(SLIBNAME_WITH_MAJOR) $(SLIBNAME)
 
-$(SUBDIR)$(SLIBNAME_WITH_MAJOR): $(OBJS)
+$(SUBDIR)lib$(NAME).ver: $(SRC_PATH_BARE)/$(SUBDIR)lib$(NAME).v
+	sed 's/%MAJOR%/$(lib$(NAME)_VERSION_MAJOR)/' $$^ > $$@
+
+$(SUBDIR)$(SLIBNAME_WITH_MAJOR): $(SUBDIR)lib$(NAME).ver $(OBJS)
 	$(SLIB_CREATE_DEF_CMD)
-	$(CC) $(SHFLAGS) $(FFLDFLAGS) -o $$@ $$(filter-out $(DEP_LIBS),$$^) $(FFEXTRALIBS) $(EXTRAOBJS)
+	$(CC) $(SHFLAGS) $(FFLDFLAGS) \
+		-Wl,--version-script,$(SUBDIR)lib$(NAME).ver \
+		-o $$@ $$(filter-out $(SUBDIR)lib$(NAME).ver $(DEP_LIBS),$$^) $(FFEXTRALIBS) $(EXTRAOBJS)
 	$(SLIB_EXTRA_CMD)
 
 ifdef SUBDIR
